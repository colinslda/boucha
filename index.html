<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>DaCapo.</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#fff">
  <link rel="manifest" href="data:application/manifest+json,{...}">
  <style>
    :root {
      --radius: 2rem;
      --main-padding: 1.3rem;
      --accent: #000;
      --bg: #fff;
      --text: #000;
      --grey: #ededed;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --accent: #fff;
        --bg: #111;
        --text: #fff;
        --grey: #343434;
      }
      .card {background: #181818;}
    }
    html, body {
      margin: 0; padding: 0;
      background: var(--bg);
      color: var(--text);
      font-family: 'SF Pro', -apple-system, BlinkMacSystemFont, Arial, sans-serif;
      min-height: 100vh;
      width: 100vw;
      height: 100%;
    }
    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      max-width: 430px;
      margin: 0 auto;
      box-shadow: 0 0 32px 0 rgba(0,0,0,0.07);
      border-radius: var(--radius);
      background: var(--bg);
    }
    header {
      padding: 1.5rem 0 1rem;
      text-align: center;
      font-size: 2.3rem;
      font-weight: 700;
      letter-spacing: 0.02em;
      border-bottom: 1px solid var(--grey);
      border-radius: var(--radius) var(--radius) 0 0;
      background: var(--bg);
      user-select: none;
    }
    nav {
      display: flex;
      gap: 0.5rem;
      background: var(--bg);
      padding: 0.7rem var(--main-padding) 0.6rem;
      border-bottom: 1px solid var(--grey);
      justify-content: space-around;
      font-size: 1.2rem;
      font-weight: 500;
    }
    nav button {
      flex: 1 1 auto;
      background: var(--grey);
      border: none;
      border-radius: 2rem;
      margin: 0 0.1rem;
      padding: 0.6rem 0;
      color: var(--accent);
      font-size: 1rem;
      font-family: inherit;
      transition: background .12s;
      cursor: pointer;
      outline: none;
    }
    nav button.active {
      background: var(--accent);
      color: var(--bg);
    }
    main {
      flex: 1 1 0%;
      padding: var(--main-padding);
      overflow-y: auto;
      background: var(--bg);
      border-radius: 0 0 var(--radius) var(--radius);
      min-height: 0;
    }
    .section {display: none; animation: fadeIn 0.22s;}
    .section.active {display: block;}
    .card {
      background: #fff;
      border-radius: 1.4rem;
      box-shadow: 0 2px 16px 0 rgba(0,0,0,0.06);
      padding: 1.2rem 1rem 1rem;
      margin-bottom: 1.3rem;
      border: 1px solid #ededed;
    }
    h2 {margin: 0 0 0.8em 0; font-size: 1.35rem; font-weight: 600;}
    @keyframes fadeIn {from { opacity: 0; transform: translateY(10px);} to {opacity: 1; transform: translateY(0);}}
    input, textarea {
      border-radius: 1.2rem;
      border: 1px solid #dedede;
      font-size: 1.08rem;
      width: 100%;
      padding: 0.7rem 1rem;
      margin-bottom: 0.6rem;
      background: #f9f9f9;
      color: #000;
      outline: none;
      font-family: inherit;
      transition: border .16s;
    }
    input:focus, textarea:focus {border: 1.7px solid var(--accent);}
    .timer-controls button, .add-btn {
      border-radius: 2rem;
      border: none;
      background: var(--accent);
      color: var(--bg);
      font-size: 1rem;
      padding: 0.6rem 1.3rem;
      margin: 0.2rem 0.2rem;
      cursor: pointer;
      transition: background .16s;
    }
    .timer-controls button:active, .add-btn:active {background: #222;}
    ul {padding: 0; margin: 0; list-style: none;}
    .agenda-item, .note-item {
      padding: 0.95rem 1rem 0.95rem 0.7rem;
      border-bottom: 1px solid #ededed;
      font-size: 1.07rem;
      border-radius: 0.8rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.7rem;
    }
    .agenda-item:last-child, .note-item:last-child {border-bottom: none;}
    .delete-btn {
      background: transparent;
      border: none;
      color: #888;
      font-size: 1.3rem;
      cursor: pointer;
      margin-left: 0.3rem;
    }
    .delete-btn:active {color: #e00;}
    .subtle {color: #777; font-size: 0.98em;}
    .search-bar {margin-bottom: 0.8rem;}
    .stats {font-size:0.98em;color:var(--accent);}
    @media (max-width: 440px) {
      #app { max-width: 100vw;}
      main { padding: 0.7rem;}
    }
    body { padding-bottom: env(safe-area-inset-bottom); }
  </style>
</head>
<body>
  <div id="app">
    <header>DaCapo.<span style="font-size:1.5rem;">&nbsp;ùÑÜ</span></header>
    <nav>
      <button class="active" onclick="showSection(0)">Agenda</button>
      <button onclick="showSection(1)">Pratique</button>
      <button onclick="showSection(2)">Notes</button>
      <button onclick="showSection(3)">√Ä propos</button>
    </nav>
    <main>
      <!-- Agenda -->
      <section class="section active" id="agenda">
        <div class="card">
          <h2>Agenda</h2>
          <input class="search-bar" id="agenda-search" type="text" placeholder="Rechercher un √©v√®nement...">
          <form id="agenda-form">
            <input type="text" id="agenda-title" placeholder="Titre (ex : R√©p√©tition Quatuor)" required>
            <input type="datetime-local" id="agenda-date" required>
            <button type="submit" class="add-btn">Ajouter</button>
          </form>
          <ul id="agenda-list"></ul>
        </div>
      </section>
      <!-- Pratique -->
      <section class="section" id="practice">
        <div class="card">
          <h2>Timer de pratique</h2>
          <div style="font-size:2.5rem;text-align:center;margin:1rem 0;" id="timer">00:00:00</div>
          <div class="timer-controls" style="text-align:center;">
            <button onclick="startTimer()">D√©marrer</button>
            <button onclick="pauseTimer()">Pause</button>
            <button onclick="resetTimer()">R√©initialiser</button>
          </div>
          <div class="stats" id="practice-stats"></div>
        </div>
        <div class="card">
          <h2>Historique de pratique</h2>
          <ul id="practice-log"></ul>
        </div>
      </section>
      <!-- Notes -->
      <section class="section" id="notes">
        <div class="card">
          <h2>Notes</h2>
          <input class="search-bar" id="notes-search" type="text" placeholder="Rechercher une note...">
          <form id="notes-form">
            <textarea id="note-input" rows="2" maxlength="400" placeholder="Ex : Id√©e de phras√©, doigt√©s, agenda cours, etc."></textarea>
            <button type="submit" class="add-btn">Ajouter</button>
          </form>
          <ul id="notes-list"></ul>
        </div>
      </section>
      <!-- √Ä propos -->
      <section class="section" id="about">
        <div class="card">
          <h2>√Ä propos</h2>
          <p>DaCapo.<br>
          Application PWA minimaliste pour violoniste √©tudiant.<br>
          Cr√©√©e pour <b>Colin</b> par ChatGPT.<br>
          Design <b>Apple noir & blanc</b>, agenda, timer, notes.<br>
          <span class="subtle">Mets-la sur ton √©cran d‚Äôaccueil pour un effet ‚Äúapp native‚Äù !</span></p>
          <p class="subtle">Fonctionnalit√©s‚ÄØ: notifications agenda, stats de pratique, recherche, mode sombre, suppression s√©curis√©e.</p>
        </div>
      </section>
    </main>
  </div>
  <script>
    // Navigation
    function showSection(idx) {
      document.querySelectorAll('nav button').forEach((btn, i) =>
        btn.classList.toggle('active', i === idx)
      );
      document.querySelectorAll('.section').forEach((sec, i) =>
        sec.classList.toggle('active', i === idx)
      );
    }

    // Notifications
    let notificationPermission = false;
    if ('Notification' in window) {
      Notification.requestPermission().then(p => notificationPermission = p === 'granted');
    }

    // Agenda
    const agendaList = document.getElementById('agenda-list');
    const agendaForm = document.getElementById('agenda-form');
    const agendaSearch = document.getElementById('agenda-search');

    function sendAgendaNotification(item) {
      if (!notificationPermission) return;
      const date = new Date(item.date);
      const now = Date.now();
      const timeout = date.getTime() - now - 5*60*1000; // 5 min avant
      if (timeout > 0) {
        setTimeout(() => {
          new Notification('Rappel Agenda', {body: item.title + ' √† ' + date.toLocaleString('fr-CH')});
        }, timeout);
      }
    }

    function filterAgenda(arr) {
      const q = agendaSearch.value.trim().toLowerCase();
      if (!q) return arr;
      return arr.filter(item => item.title.toLowerCase().includes(q));
    }

    function loadAgenda() {
      agendaList.innerHTML = '';
      let arr = JSON.parse(localStorage.getItem('agenda')||'[]');
      arr = filterAgenda(arr);
      arr.forEach((item, i) => {
        const li = document.createElement('li');
        li.className = "agenda-item";
        li.innerHTML = `<span>
          <b>${item.title}</b><br>
          <span class="subtle">${new Date(item.date).toLocaleString('fr-CH')}</span>
        </span>
        <button class="delete-btn" title="Supprimer" onclick="confirmDeleteAgenda(${i})">&times;</button>`;
        agendaList.appendChild(li);
      });
    }
    function confirmDeleteAgenda(idx) {
      if (confirm('Supprimer cet √©v√©nement‚ÄØ?')) deleteAgenda(idx);
    }
    function deleteAgenda(idx){
      let arr = JSON.parse(localStorage.getItem('agenda')||'[]');
      arr.splice(idx,1); localStorage.setItem('agenda', JSON.stringify(arr)); loadAgenda();
    }
    agendaForm.onsubmit = e => {
      e.preventDefault();
      let arr = JSON.parse(localStorage.getItem('agenda')||'[]');
      let item = {title: agendaForm['agenda-title'].value, date: agendaForm['agenda-date'].value};
      arr.unshift(item);
      localStorage.setItem('agenda', JSON.stringify(arr));
      agendaForm.reset(); loadAgenda();
      sendAgendaNotification(item);
    };
    agendaSearch.oninput = loadAgenda;
    loadAgenda();

    // Timer de pratique
    let timer=0, running=false, timerInterval;
    function updateTimer() {
      let h = String(Math.floor(timer/3600)).padStart(2,'0'),
          m = String(Math.floor((timer%3600)/60)).padStart(2,'0'),
          s = String(timer%60).padStart(2,'0');
      document.getElementById('timer').textContent = `${h}:${m}:${s}`;
    }
    function startTimer() {
      if(running) return;
      running = true;
      timerInterval = setInterval(() => { timer++; updateTimer(); }, 1000);
    }
    function pauseTimer() {
      running = false; clearInterval(timerInterval);
    }
    function resetTimer() {
      pauseTimer();
      if(timer>0) savePractice(timer);
      timer = 0; updateTimer();
    }
    function savePractice(sec){
      let arr = JSON.parse(localStorage.getItem('practice-log')||'[]');
      arr.unshift({date: Date.now(), duration: sec});
      localStorage.setItem('practice-log', JSON.stringify(arr));
      loadPracticeLog(); loadPracticeStats();
    }
    function loadPracticeLog() {
      let arr = JSON.parse(localStorage.getItem('practice-log')||'[]');
      const log = document.getElementById('practice-log');
      log.innerHTML = '';
      arr.slice(0,7).forEach(item=>{
        let d = new Date(item.date);
        let h = Math.floor(item.duration/3600), m = Math.floor((item.duration%3600)/60);
        let dur = (h ? h+'h ':'') + (m ? m+'min' : '');
        let li = document.createElement('li');
        li.className = 'agenda-item';
        li.innerHTML = `<span>${d.toLocaleDateString('fr-CH')}<span class="subtle"> (${dur||item.duration+'s'})</span></span>`;
        log.appendChild(li);
      });
    }
    function loadPracticeStats() {
      let arr = JSON.parse(localStorage.getItem('practice-log')||'[]');
      let thisWeek = 0, thisMonth = 0;
      let now = new Date();
      arr.forEach(item => {
        let d = new Date(item.date);
        // Week: ISO week number
        if (d.getFullYear() === now.getFullYear() && getWeek(d) === getWeek(now)) thisWeek += item.duration;
        if (d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth()) thisMonth += item.duration;
      });
      document.getElementById('practice-stats').textContent =
        `Cette semaine‚ÄØ: ${secToHMS(thisWeek)} | Ce mois‚ÄØ: ${secToHMS(thisMonth)}`;
    }
    function secToHMS(sec) {
      let h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s = sec%60;
      return (h ? h+'h ' : '') + (m ? m+'min ' : '') + (!h && !m ? s+'s' : '');
    }
    function getWeek(d) {
      d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
      let yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      return Math.ceil((((d - yearStart)/86400000)+1)/7);
    }
    updateTimer(); loadPracticeLog(); loadPracticeStats();

    // Notes
    const notesList = document.getElementById('notes-list');
    const notesForm = document.getElementById('notes-form');
    const notesSearch = document.getElementById('notes-search');
    function filterNotes(arr) {
      const q = notesSearch.value.trim().toLowerCase();
      if (!q) return arr;
      return arr.filter(txt => txt.toLowerCase().includes(q));
    }
    function loadNotes() {
      notesList.innerHTML = '';
      let arr = JSON.parse(localStorage.getItem('notes')||'[]');
      arr = filterNotes(arr);
      arr.forEach((txt,i)=>{
        const li = document.createElement('li');
        li.className = 'note-item';
        li.innerHTML = `<span>${txt}</span>
          <button class="delete-btn" title="Supprimer" onclick="confirmDeleteNote(${i})">&times;</button>`;
        notesList.appendChild(li);
      });
    }
    function confirmDeleteNote(idx) {
      if (confirm('Supprimer cette note‚ÄØ?')) deleteNote(idx);
    }
    function deleteNote(idx){
      let arr = JSON.parse(localStorage.getItem('notes')||'[]');
      arr.splice(idx,1); localStorage.setItem('notes', JSON.stringify(arr)); loadNotes();
    }
    notesForm.onsubmit = e=>{
      e.preventDefault();
      let arr = JSON.parse(localStorage.getItem('notes')||'[]');
      let txt = notesForm['note-input'].value.trim();
      if(txt) { arr.unshift(txt); localStorage.setItem('notes', JSON.stringify(arr)); }
      notesForm.reset(); loadNotes();
    };
    notesSearch.oninput = loadNotes;
    loadNotes();

    // PWA : Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        const sw = `
        self.addEventListener('install', e => e.waitUntil(self.skipWaiting()));
        self.addEventListener('activate', e => e.waitUntil(self.clients.claim()));
        self.addEventListener('fetch', function(event) {
          event.respondWith(
            caches.open('dacapo-cache').then(function(cache) {
              return cache.match(event.request).then(function (resp) {
                return resp || fetch(event.request).then(function(response) {
                  if(event.request.url.startsWith('http')) cache.put(event.request, response.clone());
                  return response;
                });
              })
            })
          );
        });
        `;
        const blob = new Blob([sw], {type: 'application/javascript'});
        const url = URL.createObjectURL(blob);
        navigator.serviceWorker.register(url);
      });
    }
  </script>
</body>
</html>
